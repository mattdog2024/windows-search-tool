---
name: 项目基础架构搭建
status: completed
created: 2025-10-16T08:21:20Z
updated: 2025-10-17T01:36:46Z
completed: 2025-10-16T10:30:00Z
github: https://github.com/mattdog2024/windows-search-tool/issues/2
depends_on: []
parallel: true
conflicts_with: []
---

# Task: 项目基础架构搭建

## Description

搭建 Windows Search Tool 项目的基础框架,包括目录结构、配置管理模块、日志系统和单元测试框架。这是整个项目的基石,为后续开发提供标准化的代码组织和通用工具。

**核心目标:**
- 建立清晰的项目目录结构(src/, tests/, resources/, docs/)
- 实现灵活的配置管理系统(JSON 配置文件)
- 搭建完善的日志系统(RotatingFileHandler)
- 配置单元测试框架(pytest + pytest-cov)

## Acceptance Criteria

- [ ] 项目目录结构完整创建
  - src/ (源代码目录)
    - ui/ (用户界面)
    - core/ (核心业务逻辑)
    - parsers/ (文档解析器)
    - services/ (外部服务)
    - data/ (数据访问层)
    - utils/ (工具类)
  - tests/ (测试目录)
    - unit/ (单元测试)
    - integration/ (集成测试)
    - fixtures/ (测试数据)
  - resources/ (资源文件)
    - icons/
    - themes/
    - config/
  - docs/ (文档)
  - logs/ (日志目录)

- [ ] 配置管理模块实现
  - ConfigManager 类支持 JSON 配置读写
  - 支持默认配置和用户配置合并
  - 配置文件路径: %APPDATA%/WindowsSearchTool/config.json
  - 配置验证和错误处理

- [ ] 日志系统实现
  - 使用 RotatingFileHandler(最大 10MB,保留 5 个备份)
  - 支持多个日志级别(DEBUG, INFO, WARNING, ERROR, CRITICAL)
  - 日志格式: `%(asctime)s - %(name)s - %(levelname)s - %(message)s`
  - 日志文件路径: %APPDATA%/WindowsSearchTool/logs/app.log
  - 控制台和文件双输出

- [ ] 单元测试框架搭建
  - pytest 配置完成(pytest.ini)
  - pytest-cov 集成(覆盖率报告)
  - 测试文件命名规范(test_*.py)
  - 基础测试用例示例

- [ ] 依赖管理
  - requirements.txt 包含所有必需依赖
  - requirements-dev.txt 包含开发依赖
  - README.md 包含安装和运行说明

- [ ] 基础工具类实现
  - 文件系统操作工具(路径处理、文件检查)
  - 哈希计算工具(SHA256)
  - 时间格式化工具

## Technical Details

### 配置管理模块

```python
# src/utils/config.py
import json
import os
from pathlib import Path
from typing import Any, Dict

class ConfigManager:
    """配置管理器"""

    DEFAULT_CONFIG = {
        "app": {
            "name": "Windows Search Tool",
            "version": "1.0.0",
            "theme": "light"
        },
        "database": {
            "cache_size_mb": 64,
            "page_size": 4096,
            "wal_mode": True
        },
        "indexing": {
            "parallel_workers": 4,
            "batch_size": 100,
            "excluded_extensions": [".exe", ".dll", ".sys"],
            "excluded_paths": ["C:\\Windows", "C:\\Program Files"]
        },
        "search": {
            "results_per_page": 20,
            "snippet_length": 100,
            "cache_size": 100
        },
        "ocr": {
            "tesseract_path": "C:\\Program Files\\Tesseract-OCR\\tesseract.exe",
            "languages": ["chi_sim", "eng"],
            "confidence_threshold": 60
        }
    }

    def __init__(self):
        self.config_dir = Path(os.getenv('APPDATA')) / 'WindowsSearchTool'
        self.config_file = self.config_dir / 'config.json'
        self.config = self._load_config()

    def _load_config(self) -> Dict[str, Any]:
        """加载配置"""
        if self.config_file.exists():
            with open(self.config_file, 'r', encoding='utf-8') as f:
                user_config = json.load(f)
                return self._merge_config(self.DEFAULT_CONFIG, user_config)
        return self.DEFAULT_CONFIG.copy()

    def _merge_config(self, default: Dict, user: Dict) -> Dict:
        """递归合并配置"""
        result = default.copy()
        for key, value in user.items():
            if key in result and isinstance(result[key], dict) and isinstance(value, dict):
                result[key] = self._merge_config(result[key], value)
            else:
                result[key] = value
        return result

    def save(self):
        """保存配置"""
        self.config_dir.mkdir(parents=True, exist_ok=True)
        with open(self.config_file, 'w', encoding='utf-8') as f:
            json.dump(self.config, f, indent=2, ensure_ascii=False)

    def get(self, key: str, default=None) -> Any:
        """获取配置值(支持点分隔符,如 'app.name')"""
        keys = key.split('.')
        value = self.config
        for k in keys:
            if isinstance(value, dict) and k in value:
                value = value[k]
            else:
                return default
        return value

    def set(self, key: str, value: Any):
        """设置配置值"""
        keys = key.split('.')
        config = self.config
        for k in keys[:-1]:
            if k not in config:
                config[k] = {}
            config = config[k]
        config[keys[-1]] = value
```

### 日志系统

```python
# src/utils/logger.py
import logging
import os
from pathlib import Path
from logging.handlers import RotatingFileHandler

def setup_logger(name: str, level=logging.INFO) -> logging.Logger:
    """设置日志记录器"""

    logger = logging.getLogger(name)
    logger.setLevel(level)

    # 日志目录
    log_dir = Path(os.getenv('APPDATA')) / 'WindowsSearchTool' / 'logs'
    log_dir.mkdir(parents=True, exist_ok=True)
    log_file = log_dir / 'app.log'

    # 文件处理器(Rotating,最大10MB,保留5个备份)
    file_handler = RotatingFileHandler(
        log_file,
        maxBytes=10 * 1024 * 1024,  # 10MB
        backupCount=5,
        encoding='utf-8'
    )
    file_handler.setLevel(level)

    # 控制台处理器
    console_handler = logging.StreamHandler()
    console_handler.setLevel(level)

    # 格式化器
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    file_handler.setFormatter(formatter)
    console_handler.setFormatter(formatter)

    # 添加处理器
    logger.addHandler(file_handler)
    logger.addHandler(console_handler)

    return logger
```

### 项目结构

```
windows-search-tool/
├── src/
│   ├── __init__.py
│   ├── main.py              # 程序入口
│   ├── ui/                  # 用户界面
│   │   └── __init__.py
│   ├── core/                # 核心业务逻辑
│   │   └── __init__.py
│   ├── parsers/             # 文档解析器
│   │   └── __init__.py
│   ├── services/            # 外部服务
│   │   └── __init__.py
│   ├── data/                # 数据访问层
│   │   └── __init__.py
│   └── utils/               # 工具类
│       ├── __init__.py
│       ├── config.py        # 配置管理
│       ├── logger.py        # 日志工具
│       └── file_utils.py    # 文件工具
├── tests/
│   ├── __init__.py
│   ├── unit/
│   │   ├── __init__.py
│   │   └── test_config.py
│   ├── integration/
│   │   └── __init__.py
│   └── fixtures/
│       └── sample_files/
├── resources/
│   ├── icons/
│   ├── themes/
│   └── config/
│       └── default_config.json
├── docs/
├── logs/
├── requirements.txt
├── requirements-dev.txt
├── pytest.ini
├── .gitignore
└── README.md
```

## Dependencies

**外部依赖:**
- Python 3.11+
- pytest 7.4+
- pytest-cov

**前置工作:**
- 确认 Python 3.11+ 已安装
- 确认 pip 可用

## Effort Estimate

- **Size:** S (Small)
- **Hours:** 8-12 小时
- **Parallel:** true (可与其他模块并行开发)

**时间分配:**
- 目录结构创建: 1 小时
- 配置管理模块: 3 小时
- 日志系统: 2 小时
- 测试框架搭建: 2 小时
- 文档编写: 2 小时
- 测试和调试: 2 小时

## Definition of Done

- [x] 代码实现完成
  - 项目目录结构创建
  - ConfigManager 类实现
  - Logger 工具实现
  - 基础工具类实现

- [x] 测试完成
  - ConfigManager 单元测试覆盖率 ≥ 90%
  - Logger 功能测试通过
  - pytest 框架正常运行

- [x] 文档完成
  - README.md 包含安装说明
  - requirements.txt 包含所有依赖
  - 代码注释完整

- [x] 代码质量
  - 通过 black 格式化
  - 通过 pylint 检查(评分 ≥ 8.0)
  - 类型注解完整

- [x] 验收测试
  - 配置文件可正常读写
  - 日志文件可正常生成和轮转
  - 测试框架可正常执行
