---
name: 打包部署和端到端测试
status: open
created: 2025-10-16T08:21:20Z
updated: 2025-10-16T08:21:20Z
github: https://github.com/mattdog2024/windows-search-tool/issues/11
depends_on: [006, 007, 008, 009]
parallel: false
conflicts_with: []
---

# Task: 打包部署和端到端测试

## Description

配置 PyInstaller 打包脚本,将应用程序打包为独立的 Windows 可执行文件(.exe),包含所有依赖和资源。编写完整的端到端测试,验证所有功能正常工作。编写用户手册和部署文档,执行性能基准测试和优化。

**核心目标:**
- 配置 PyInstaller 打包脚本(单文件/多文件模式)
- 打包所有依赖库和资源文件(图标、配置等)
- 处理 Tesseract OCR 外部依赖
- 编写完整的端到端测试
- 执行性能基准测试和优化
- 编写用户手册和安装指南
- 发布首个可用版本

## Acceptance Criteria

- [ ] PyInstaller 配置
  - **打包脚本(.spec 文件)**
    - 单文件模式配置(--onefile)
    - 多文件模式配置(--onedir,推荐)
    - 添加应用图标(--icon)
    - 隐藏控制台窗口(--noconsole,可选)
    - 排除不必要的库(--exclude-module)

  - **依赖处理**
    - 自动检测 Python 依赖
    - 包含数据文件(配置、模板、图标等)
    - 包含 SQLite 数据库文件
    - 包含第三方库资源(如 tkinter themes)

- [ ] 外部依赖处理
  - **Tesseract OCR**
    - 检测 Tesseract 安装
    - 提供 Tesseract 下载链接
    - 可选打包 Tesseract(增加体积)
    - 语言包配置说明

  - **运行时检查**
    - 启动时检测必需依赖
    - 缺失依赖时友好提示
    - 提供安装指南链接

- [ ] 打包优化
  - **体积优化**
    - 排除不必要的模块
    - 压缩可执行文件(UPX)
    - 优化资源文件大小
    - 目标: < 100MB(不含 Tesseract)

  - **启动优化**
    - 延迟导入大型库
    - 优化初始化流程
    - 启动画面(Splash Screen,可选)
    - 目标: 启动时间 < 5 秒

- [ ] 端到端测试
  - **功能测试**
    - 文件扫描和索引测试
    - 文档解析测试(所有支持格式)
    - 搜索功能测试(关键词、全文、日期)
    - OCR 功能测试
    - AI 摘要测试(如果启用)
    - GUI 交互测试

  - **兼容性测试**
    - Windows 10 测试
    - Windows 11 测试
    - 不同语言环境测试(中文、英文)
    - 不同分辨率测试
    - 不同 DPI 设置测试

  - **边界测试**
    - 大文件处理(> 100MB)
    - 大量文件扫描(> 10,000 个)
    - 特殊字符文件名
    - 损坏文件处理
    - 网络中断测试(AI 功能)

- [ ] 性能基准测试
  - **索引性能**
    - 1,000 个文件索引时间
    - 10,000 个文件索引时间
    - 不同文件类型性能对比
    - 内存使用情况

  - **搜索性能**
    - 关键词搜索响应时间(< 100ms)
    - 全文搜索响应时间(< 500ms)
    - 大数据集搜索性能
    - 并发搜索性能

  - **OCR 性能**
    - 单页 OCR 时间(< 10 秒)
    - 多页 PDF 处理时间
    - 内存占用情况

  - **GUI 性能**
    - 界面响应速度
    - 大列表渲染性能
    - 滚动流畅度

- [ ] 性能优化
  - 识别性能瓶颈(profiling)
  - 数据库查询优化
  - 缓存策略优化
  - 多线程优化
  - 内存泄漏修复

- [ ] 用户文档
  - **用户手册**
    - 功能介绍和使用说明
    - 界面说明(带截图)
    - 搜索技巧和最佳实践
    - 常见问题解答(FAQ)

  - **安装指南**
    - 系统要求说明
    - 安装步骤(带截图)
    - Tesseract OCR 安装
    - DeepSeek API 配置(可选)
    - 故障排除指南

  - **开发文档**
    - 架构设计文档
    - API 文档
    - 数据库设计文档
    - 扩展开发指南

- [ ] 发布准备
  - 版本号管理(语义化版本)
  - 更新日志(CHANGELOG.md)
  - 许可证声明(LICENSE)
  - README 文档
  - GitHub Release 准备

## Technical Details

### PyInstaller 配置

```python
# build.spec
# -*- mode: python ; coding: utf-8 -*-

block_cipher = None

a = Analysis(
    ['src/main.py'],
    pathex=[],
    binaries=[],
    datas=[
        ('config', 'config'),           # 配置文件
        ('assets', 'assets'),           # 资源文件(图标等)
        ('README.md', '.'),
        ('LICENSE', '.'),
    ],
    hiddenimports=[
        'PIL._tkinter_finder',          # Pillow 依赖
        'tkinter',
        'sqlite3',
        'pytesseract',
        'docx',
        'openpyxl',
        'pptx',
        'pdfplumber',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[
        'matplotlib',                    # 排除不需要的大型库
        'numpy.testing',
        'pytest',
    ],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    [],
    exclude_binaries=True,
    name='WindowsSearchTool',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,                           # 使用 UPX 压缩
    console=False,                      # 隐藏控制台窗口
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon='assets/icon.ico'              # 应用图标
)

coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=True,
    upx_exclude=[],
    name='WindowsSearchTool'
)
```

### 打包脚本

```python
# build.py
"""
PyInstaller 打包脚本
"""
import os
import sys
import shutil
import subprocess
from pathlib import Path

def clean_build():
    """清理构建目录"""
    dirs_to_clean = ['build', 'dist', '__pycache__']
    for dir_name in dirs_to_clean:
        if os.path.exists(dir_name):
            shutil.rmtree(dir_name)
            print(f"Cleaned: {dir_name}")

def build_onedir():
    """打包为目录模式(推荐)"""
    print("Building in onedir mode...")
    cmd = [
        'pyinstaller',
        '--clean',
        '--noconfirm',
        'build.spec'
    ]
    subprocess.run(cmd, check=True)
    print("Build completed: dist/WindowsSearchTool/")

def build_onefile():
    """打包为单文件模式"""
    print("Building in onefile mode...")
    cmd = [
        'pyinstaller',
        '--clean',
        '--noconfirm',
        '--onefile',
        '--windowed',
        '--icon=assets/icon.ico',
        '--name=WindowsSearchTool',
        'src/main.py'
    ]
    subprocess.run(cmd, check=True)
    print("Build completed: dist/WindowsSearchTool.exe")

def create_installer():
    """创建安装程序(使用 Inno Setup)"""
    print("Creating installer...")
    # TODO: 配置 Inno Setup 脚本
    pass

def main():
    """主函数"""
    print("Windows Search Tool - Build Script")
    print("=" * 50)

    # 清理
    clean_build()

    # 选择打包模式
    mode = input("Select build mode (1=onedir, 2=onefile): ").strip()

    if mode == '1':
        build_onedir()
    elif mode == '2':
        build_onefile()
    else:
        print("Invalid mode")
        sys.exit(1)

    print("\nBuild successful!")
    print("Output: dist/")

if __name__ == '__main__':
    main()
```

### 启动检查

```python
# src/utils/startup_check.py
"""
启动时依赖检查
"""
import sys
import logging
from pathlib import Path

logger = logging.getLogger(__name__)

def check_dependencies() -> bool:
    """
    检查必需依赖

    Returns:
        所有依赖满足返回 True
    """
    missing = []

    # 检查 Python 版本
    if sys.version_info < (3, 8):
        print("Error: Python 3.8+ is required")
        return False

    # 检查必需的 Python 库
    required_modules = [
        'tkinter',
        'sqlite3',
        'PIL',
        'docx',
        'openpyxl',
        'pptx',
        'pdfplumber',
    ]

    for module in required_modules:
        try:
            __import__(module)
        except ImportError:
            missing.append(module)
            logger.error(f"Missing module: {module}")

    # 检查 Tesseract(可选)
    try:
        import pytesseract
        pytesseract.get_tesseract_version()
        logger.info("Tesseract OCR is available")
    except Exception as e:
        logger.warning(f"Tesseract OCR not available: {e}")
        print("Warning: Tesseract OCR is not installed. OCR features will be disabled.")
        print("Download: https://github.com/UB-Mannheim/tesseract/wiki")

    if missing:
        print(f"\nError: Missing required modules: {', '.join(missing)}")
        print("Please reinstall the application or contact support.")
        return False

    return True

def check_config() -> bool:
    """检查配置文件"""
    config_file = Path('config/config.json')

    if not config_file.exists():
        logger.warning("Config file not found, creating default...")
        create_default_config()

    return True

def create_default_config():
    """创建默认配置"""
    from src.config import Config
    config = Config()
    config.save()
    logger.info("Default config created")

def startup_check():
    """启动检查"""
    logger.info("Running startup checks...")

    if not check_dependencies():
        sys.exit(1)

    if not check_config():
        sys.exit(1)

    logger.info("Startup checks passed")
```

### 端到端测试

```python
# tests/test_e2e.py
"""
端到端测试
"""
import pytest
import tempfile
import shutil
from pathlib import Path
from src.indexer import DocumentIndexer
from src.search_engine import SearchEngine
from src.database.db_manager import DatabaseManager

class TestE2E:
    """端到端测试"""

    @pytest.fixture
    def test_env(self):
        """测试环境"""
        # 创建临时目录
        temp_dir = tempfile.mkdtemp()
        db_path = Path(temp_dir) / 'test.db'

        # 创建测试文件
        test_files_dir = Path(temp_dir) / 'files'
        test_files_dir.mkdir()

        # Word 文档
        (test_files_dir / 'test.docx').write_text('测试文档内容')

        # 文本文件
        (test_files_dir / 'test.txt').write_text('Hello World 你好世界')

        # PDF 文件(需要真实文件)
        # ...

        yield {
            'temp_dir': temp_dir,
            'db_path': db_path,
            'files_dir': test_files_dir
        }

        # 清理
        shutil.rmtree(temp_dir)

    def test_full_workflow(self, test_env):
        """测试完整工作流程"""
        # 1. 初始化
        db = DatabaseManager(test_env['db_path'])
        indexer = DocumentIndexer(db)
        search = SearchEngine(db)

        # 2. 扫描和索引
        files = indexer.scan_directory(test_env['files_dir'])
        assert len(files) >= 2

        indexer.index_files(files)

        # 3. 搜索
        results = search.search('测试')
        assert len(results) > 0

        # 4. 全文搜索
        results = search.full_text_search('Hello')
        assert len(results) > 0

        # 5. 日期搜索
        results = search.search_by_date_range(
            start_date='2024-01-01',
            end_date='2025-12-31'
        )
        assert len(results) > 0

    def test_ocr_workflow(self, test_env):
        """测试 OCR 工作流程"""
        # 需要真实的扫描 PDF 文件
        pass

    def test_ai_workflow(self, test_env):
        """测试 AI 工作流程"""
        # 需要配置 DeepSeek API
        pass
```

### 性能测试

```python
# tests/test_performance.py
"""
性能基准测试
"""
import pytest
import time
import psutil
from pathlib import Path

class TestPerformance:
    """性能测试"""

    def test_indexing_performance(self, benchmark_files):
        """测试索引性能"""
        start_time = time.time()
        start_memory = psutil.Process().memory_info().rss / 1024 / 1024

        # 索引文件
        indexer = DocumentIndexer(db)
        indexer.index_files(benchmark_files)

        end_time = time.time()
        end_memory = psutil.Process().memory_info().rss / 1024 / 1024

        elapsed = end_time - start_time
        memory_used = end_memory - start_memory

        print(f"\nIndexing Performance:")
        print(f"  Files: {len(benchmark_files)}")
        print(f"  Time: {elapsed:.2f}s")
        print(f"  Speed: {len(benchmark_files)/elapsed:.2f} files/s")
        print(f"  Memory: {memory_used:.2f} MB")

        # 性能要求
        assert elapsed < 60, "Indexing should complete in 60s for 1000 files"
        assert memory_used < 500, "Memory usage should be < 500MB"

    def test_search_performance(self, indexed_db):
        """测试搜索性能"""
        search = SearchEngine(indexed_db)

        # 关键词搜索
        start = time.time()
        results = search.search('test')
        keyword_time = time.time() - start

        # 全文搜索
        start = time.time()
        results = search.full_text_search('test content')
        fulltext_time = time.time() - start

        print(f"\nSearch Performance:")
        print(f"  Keyword search: {keyword_time*1000:.2f}ms")
        print(f"  Full-text search: {fulltext_time*1000:.2f}ms")

        # 性能要求
        assert keyword_time < 0.1, "Keyword search should be < 100ms"
        assert fulltext_time < 0.5, "Full-text search should be < 500ms"
```

## Dependencies

**外部依赖:**
- PyInstaller 6.0+
- UPX (可选,用于压缩)
- Inno Setup (可选,用于创建安装程序)

**测试依赖:**
- pytest 7.0+
- pytest-benchmark 4.0+
- psutil 5.9+

**内部依赖:**
- Task 006: GUI 实现
- Task 007: 搜索功能
- Task 008: OCR 集成
- Task 009: AI 服务

## Effort Estimate

- **Size:** L (Large)
- **Hours:** 16-20 小时
- **Parallel:** false (依赖所有前置任务)

**时间分配:**
- PyInstaller 配置和调试: 4 小时
- 端到端测试编写: 4 小时
- 性能测试和优化: 4 小时
- 用户文档编写: 4 小时
- 发布准备: 2 小时
- Bug 修复和调优: 2 小时

## Definition of Done

- [x] 打包完成
  - PyInstaller 配置正确
  - 可执行文件成功生成
  - 所有依赖正确包含
  - 程序能正常启动和运行
  - 体积优化到合理范围(< 100MB)

- [x] 测试完成
  - 所有端到端测试通过
  - 兼容性测试通过(Windows 10/11)
  - 性能测试通过(满足性能要求)
  - 边界测试通过
  - 无严重 Bug

- [x] 文档完成
  - 用户手册编写完成
  - 安装指南编写完成
  - FAQ 文档完成
  - 开发文档完成
  - README 完善

- [x] 发布准备
  - 版本号确定(v1.0.0)
  - CHANGELOG 编写
  - LICENSE 文件
  - GitHub Release 准备
  - 下载和安装测试

- [x] 验收测试
  - 在干净的 Windows 系统上安装测试
  - 所有核心功能正常工作
  - 用户文档清晰易懂
  - 无崩溃和严重错误
  - 性能满足要求

## Notes

**打包注意事项:**
- 测试打包后的程序,不要只依赖开发环境
- 注意处理相对路径和绝对路径
- 大文件(如 Tesseract)考虑单独下载
- 提供详细的错误日志便于调试

**性能优化建议:**
- 使用 cProfile 分析性能瓶颈
- 优化数据库索引
- 使用连接池和缓存
- 考虑使用 C 扩展加速关键操作

**发布清单:**
- [ ] 代码冻结
- [ ] 所有测试通过
- [ ] 文档完善
- [ ] 版本号更新
- [ ] 生成可执行文件
- [ ] 在不同系统上测试
- [ ] 创建 GitHub Release
- [ ] 发布公告

**未来改进:**
- 自动更新功能
- 多语言支持
- 云同步功能
- 更多文档格式支持
- macOS/Linux 版本
