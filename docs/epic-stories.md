# Epic Stories - Windows Search Tool

**项目:** Windows Search Tool
**项目级别:** Level 2
**日期:** 2025-10-16
**版本:** 1.0

---

## 概述

本文档详细定义了 Windows Search Tool 项目的两个主要史诗(Epics)及其包含的用户故事(Stories)。每个故事都包含了具体的实现要求、验收标准和技术细节。

### 项目目标回顾

1. **完全替代 Archivarius 3000** - 支持现代文档格式和 PDF OCR
2. **构建持久化知识库** - 创建可永久保存的内容索引
3. **提供智能搜索体验** - 集成 AI 实现语义搜索

---

## Epic 1: 核心搜索引擎

**史诗描述:** 构建高性能的文档索引和搜索引擎，支持多种文档格式，提供快速准确的全文搜索能力。

**业务价值:** 这是整个系统的核心基础，决定了搜索的速度和准确性。

**故事数量:** 8
**预估工作量:** 3-4 周

---

### Story 1.1: 实现文档解析框架

**作为** 系统开发者
**我想要** 建立一个可扩展的文档解析框架
**以便** 能够轻松添加新的文档格式支持

**描述:**
创建一个统一的文档解析接口和框架，定义标准的解析器接口，实现插件式的解析器注册机制。

**验收标准:**
- [ ] 定义 `IDocumentParser` 接口，包含 `parse()`, `supports()`, `getMetadata()` 方法
- [ ] 实现 `ParserRegistry` 类，支持解析器的注册和查找
- [ ] 创建 `ParseResult` 数据结构，包含文本内容、元数据、解析状态
- [ ] 支持按文件扩展名自动选择合适的解析器
- [ ] 处理解析错误和异常情况
- [ ] 编写单元测试，覆盖率达到 90%

**技术细节:**
- 使用 Python 的抽象基类 (ABC) 定义接口
- 支持同步和异步解析模式
- 提供解析进度回调机制

**依赖:** 无

**优先级:** P0 (最高)

---

### Story 1.2: 开发 Office 新格式解析器 (docx/xlsx/pptx)

**作为** 用户
**我想要** 系统能够索引 Microsoft Office 新格式文档
**以便** 搜索我的工作文档内容

**描述:**
实现对 .docx, .xlsx, .pptx 文件的文本提取，包括文档内容、表格数据、演示文稿文本等。

**验收标准:**
- [ ] 实现 `DocxParser` 类，提取 Word 文档的所有文本内容
  - 支持正文、表格、页眉页脚、批注
  - 提取文档属性（作者、标题、创建时间等）
- [ ] 实现 `XlsxParser` 类，提取 Excel 工作簿内容
  - 支持多个工作表
  - 提取单元格文本和公式
  - 处理合并单元格
- [ ] 实现 `PptxParser` 类，提取 PowerPoint 演示文稿文本
  - 支持标题、正文、备注
  - 提取幻灯片顺序信息
- [ ] 所有解析器正确处理中文和特殊字符
- [ ] 每个解析器都有完整的单元测试

**技术细节:**
- 使用 `python-docx` 库处理 .docx 文件
- 使用 `openpyxl` 库处理 .xlsx 文件
- 使用 `python-pptx` 库处理 .pptx 文件
- 统一字符编码为 UTF-8

**依赖:** Story 1.1

**优先级:** P0

---

### Story 1.3: 集成 PDF 处理和 OCR 功能

**作为** 用户
**我想要** 系统能够提取 PDF 文件中的文本，包括图片中的文字
**以便** 搜索扫描版 PDF 和图片文档

**描述:**
实现 PDF 文本提取，对于无法直接提取文本的 PDF，使用 OCR 技术识别图片中的文字。

**验收标准:**
- [ ] 实现 `PdfParser` 类，提取 PDF 文本内容
- [ ] 检测 PDF 类型（文本型 vs 扫描型）
- [ ] 对于文本型 PDF，直接提取文本
- [ ] 对于扫描型 PDF，自动调用 OCR 引擎
- [ ] OCR 支持中英文识别
- [ ] 提取 PDF 元数据（页数、作者、标题等）
- [ ] 处理加密 PDF（如果可能）
- [ ] 提供 OCR 进度反馈

**技术细节:**
- 使用 `PyPDF2` 或 `pdfplumber` 提取文本
- 使用 `Tesseract OCR` 进行图像文字识别
- 使用 `Pillow` 进行图像预处理（提高 OCR 准确率）
- OCR 结果置信度阈值设置为 60%

**依赖:** Story 1.1

**优先级:** P0

---

### Story 1.4: 构建 SQLite FTS5 索引数据库

**作为** 系统
**我想要** 使用高效的全文搜索数据库
**以便** 快速检索大量文档内容

**描述:**
设计并实现基于 SQLite FTS5 的索引数据库，存储文档内容和元数据。

**验收标准:**
- [ ] 设计数据库模式：
  - `documents` 表：存储文档元数据
  - `documents_fts` 表：FTS5 全文搜索表
  - `document_metadata` 表：额外的文档属性
- [ ] 实现 `IndexDatabase` 类，提供 CRUD 操作
- [ ] 配置 FTS5 分词器（支持中文分词）
- [ ] 实现批量插入优化（使用事务）
- [ ] 支持索引的备份和恢复
- [ ] 实现索引统计功能（文档数、大小、最后更新时间等）
- [ ] 数据库文件压缩和优化

**技术细节:**
- 使用 SQLite 3.35+ 版本（支持 FTS5）
- 使用 `jieba` 作为中文分词器
- 启用 WAL 模式提高并发性能
- 设置合适的 cache_size 参数

**数据库模式:**
```sql
-- 文档主表
CREATE TABLE documents (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_path TEXT NOT NULL,
    file_name TEXT NOT NULL,
    file_size INTEGER,
    file_type TEXT,
    content_hash TEXT,
    created_at DATETIME,
    modified_at DATETIME,
    indexed_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 全文搜索表
CREATE VIRTUAL TABLE documents_fts USING fts5(
    content,
    tokenize='porter unicode61'
);

-- 元数据表
CREATE TABLE document_metadata (
    document_id INTEGER,
    key TEXT,
    value TEXT,
    FOREIGN KEY(document_id) REFERENCES documents(id)
);
```

**依赖:** 无

**优先级:** P0

---

### Story 1.5: 实现增量索引机制

**作为** 用户
**我想要** 系统只索引新增和修改的文件
**以便** 节省时间和避免重复工作

**描述:**
实现智能的增量索引功能，通过文件哈希和修改时间判断文件是否需要重新索引。

**验收标准:**
- [ ] 实现文件哈希计算（使用 MD5 或 SHA256）
- [ ] 比对文件修改时间，跳过未变化的文件
- [ ] 检测文件删除，更新索引状态
- [ ] 检测文件移动/重命名
- [ ] 提供强制全量重新索引选项
- [ ] 显示增量索引统计（新增、更新、删除、跳过的文件数）
- [ ] 实现并行文件扫描和索引

**技术细节:**
- 使用 `hashlib` 计算文件哈希
- 使用 `os.stat()` 获取文件修改时间
- 使用多进程池并行处理文件
- 合理设置批处理大小（建议 100 个文件/批次）

**依赖:** Story 1.4

**优先级:** P0

---

### Story 1.6: 开发关键词搜索功能

**作为** 用户
**我想要** 通过关键词快速搜索文档
**以便** 找到包含特定内容的文件

**描述:**
实现基于关键词的全文搜索功能，支持精确匹配和模糊匹配。

**验收标准:**
- [ ] 实现精确搜索（完全匹配）
- [ ] 实现模糊搜索（部分匹配）
- [ ] 支持多关键词搜索（AND/OR 逻辑）
- [ ] 支持短语搜索（引号包裹）
- [ ] 支持通配符搜索（* 和 ?）
- [ ] 搜索结果按相关度排序
- [ ] 返回匹配的上下文片段（前后各 50 个字符）
- [ ] 搜索响应时间 < 2 秒（10 万文档）

**技术细节:**
- 使用 FTS5 的 MATCH 语法
- 实现 BM25 相关度排序算法
- 使用 snippet() 函数提取上下文
- 设置合理的搜索超时时间

**依赖:** Story 1.4

**优先级:** P0

---

### Story 1.7: 实现搜索结果排序和高亮

**作为** 用户
**我想要** 搜索结果按相关度排序并高亮关键词
**以便** 快速找到最相关的内容

**描述:**
优化搜索结果展示，实现智能排序和关键词高亮。

**验收标准:**
- [ ] 实现多维度排序：
  - 文本相关度（BM25 分数）
  - 文件修改时间（可选）
  - 文件类型权重（可配置）
- [ ] 在搜索结果中高亮显示匹配的关键词
- [ ] 支持多种高亮样式（HTML/纯文本/富文本）
- [ ] 显示匹配度百分比
- [ ] 支持自定义排序规则
- [ ] 分页显示搜索结果（每页 20 条）

**技术细节:**
- 使用 FTS5 的 rank 函数
- 实现自定义排序算法
- 使用正则表达式进行关键词高亮
- 高亮标记：`<mark>关键词</mark>`

**依赖:** Story 1.6

**优先级:** P1

---

### Story 1.8: 添加索引保存和加载功能

**作为** 用户
**我想要** 保存和加载多个索引
**以便** 管理不同来源的文档集合

**描述:**
实现索引的持久化存储，支持创建、保存、加载多个独立的索引。

**验收标准:**
- [ ] 支持将索引保存到指定目录
- [ ] 索引文件包含所有必要信息（数据库、配置、统计）
- [ ] 支持从文件加载已有索引
- [ ] 实现索引合并功能（合并多个索引为一个）
- [ ] 显示索引基本信息（名称、路径、文件数、大小、创建时间）
- [ ] 支持索引的导出和导入（跨机器使用）
- [ ] 实现索引完整性验证

**技术细节:**
- 索引存储格式：目录结构
  - `index.db` - SQLite 数据库文件
  - `config.json` - 索引配置信息
  - `metadata.json` - 索引元数据
- 支持相对路径和绝对路径
- 实现数据库文件的复制和压缩

**依赖:** Story 1.4

**优先级:** P1

---

## Epic 2: 用户界面与 AI 增强

**史诗描述:** 构建直观易用的图形界面，集成 AI 能力提供智能搜索和文档分析功能。

**业务价值:** 提升用户体验，通过 AI 增强功能提供差异化竞争优势。

**故事数量:** 6
**预估工作量:** 2-3 周

---

### Story 2.1: 设计并实现主窗口框架

**作为** 用户
**我想要** 一个清晰直观的主界面
**以便** 轻松访问所有功能

**描述:**
设计并实现应用程序的主窗口，包括菜单栏、工具栏、状态栏和主要功能区域布局。

**验收标准:**
- [ ] 实现主窗口类 `MainWindow`
- [ ] 创建菜单栏：
  - 文件菜单（新建索引、打开索引、保存、退出）
  - 编辑菜单（设置、偏好）
  - 帮助菜单（关于、使用说明）
- [ ] 创建工具栏（常用操作快捷按钮）
- [ ] 实现状态栏（显示状态信息和统计）
- [ ] 设置应用程序图标和标题
- [ ] 支持窗口大小调整和位置保存
- [ ] 实现深色/浅色主题切换

**技术细节:**
- 使用 PyQt6 或 Tkinter 构建 GUI
- 窗口最小尺寸: 1024x768
- 使用 QSettings 保存窗口状态
- 遵循 Windows 11 设计规范

**依赖:** 无

**优先级:** P0

---

### Story 2.2: 开发索引管理界面

**作为** 用户
**我想要** 方便地管理多个索引
**以便** 组织不同类型的文档集合

**描述:**
实现索引管理面板，支持创建、加载、删除索引，显示索引列表和统计信息。

**验收标准:**
- [ ] 实现索引列表视图（树形或列表形式）
- [ ] 显示每个索引的基本信息：
  - 名称、路径、文件数、总大小、最后更新时间
- [ ] 支持勾选/取消勾选索引（用于搜索范围选择）
- [ ] 实现"新建索引"对话框：
  - 选择要索引的目录
  - 设置索引名称和保存位置
  - 选择文件类型过滤
  - 配置索引选项
- [ ] 显示索引创建进度（进度条 + 百分比）
- [ ] 支持暂停/恢复/取消索引创建
- [ ] 实现索引删除功能（带确认对话框）
- [ ] 支持索引刷新（增量更新）

**技术细节:**
- 使用 QTreeWidget 或 QListWidget 显示索引列表
- 使用 QProgressDialog 显示进度
- 使用后台线程执行索引操作，避免 UI 冻结
- 实现进度回调机制

**依赖:** Story 2.1, Story 1.5, Story 1.8

**优先级:** P0

---

### Story 2.3: 实现搜索界面和结果展示

**作为** 用户
**我想要** 直观的搜索界面和清晰的结果展示
**以便** 快速找到所需文档

**描述:**
实现搜索输入框、选项设置、结果列表和详细内容查看器。

**验收标准:**
- [ ] 实现搜索输入框（支持历史记录下拉）
- [ ] 提供搜索选项：
  - 精确/模糊搜索切换
  - 文件类型过滤
  - 日期范围过滤
  - 排序方式选择
- [ ] 实现搜索结果列表：
  - 显示文件名、匹配度、修改时间
  - 显示内容预览（带关键词高亮）
  - 支持双击打开详细视图
- [ ] 实现详细内容查看器：
  - 显示完整文档内容
  - 高亮显示所有匹配关键词
  - 支持文本复制
  - 显示文档元数据
- [ ] 显示搜索耗时和结果数量
- [ ] 支持导出搜索结果（CSV/TXT）

**技术细节:**
- 使用 QLineEdit + QCompleter 实现搜索历史
- 使用 QTableView 显示搜索结果
- 使用 QTextBrowser 显示文档内容
- 使用 HTML 格式实现关键词高亮
- 实现虚拟滚动优化大量结果显示

**依赖:** Story 2.1, Story 1.6, Story 1.7

**优先级:** P0

---

### Story 2.4: 集成 DeepSeek API

**作为** 系统
**我想要** 集成 DeepSeek AI API
**以便** 提供语义搜索和智能分析功能

**描述:**
实现与 DeepSeek API 的通信，封装 API 调用，处理在线/离线模式切换。

**验收标准:**
- [ ] 实现 `DeepSeekClient` 类，封装 API 调用
- [ ] 支持配置 API Key 和端点
- [ ] 实现 API 请求/响应处理
- [ ] 处理 API 错误和超时
- [ ] 实现请求重试机制（最多 3 次）
- [ ] 检测网络连接状态
- [ ] 实现在线/离线模式自动切换
- [ ] 离线模式下禁用 AI 功能，保持基础搜索可用
- [ ] 显示当前模式状态（在线/离线）
- [ ] 实现 API 调用缓存（相同查询返回缓存结果）

**技术细节:**
- 使用 `requests` 或 `httpx` 库
- API 超时设置：10 秒
- 使用环境变量或配置文件存储 API Key
- 实现 LRU 缓存（最多 100 个条目）
- 使用异步调用避免阻塞 UI

**依赖:** 无

**优先级:** P1

---

### Story 2.5: 实现智能摘要生成

**作为** 用户
**我想要** AI 自动生成文档摘要
**以便** 快速了解文档主要内容

**描述:**
使用 DeepSeek API 为文档生成智能摘要，提取关键信息（人名、日期、金额等）。

**验收标准:**
- [ ] 实现文档摘要生成功能：
  - 生成 100-200 字的内容摘要
  - 提取关键要点（3-5 个）
- [ ] 实现关键信息提取：
  - 人名识别
  - 日期识别
  - 金额识别
  - 地点识别
  - 组织机构识别
- [ ] 在搜索结果中显示摘要（可选）
- [ ] 在详细视图中显示完整摘要和关键信息
- [ ] 支持手动触发摘要生成
- [ ] 缓存已生成的摘要，避免重复调用
- [ ] 显示摘要生成进度和状态

**技术细节:**
- 使用 DeepSeek 的文本分析能力
- 为长文档分段处理（每段最多 4000 字）
- Prompt 模板：
  ```
  请为以下文档生成摘要，并提取关键信息：
  - 摘要：100-200字
  - 关键要点：3-5个
  - 关键信息：人名、日期、金额、地点、机构

  文档内容：
  {content}
  ```
- 将摘要存储在数据库中

**依赖:** Story 2.4

**优先级:** P1

---

### Story 2.6: 添加混合模式切换功能

**作为** 用户
**我想要** 在在线和离线模式间切换
**以便** 根据网络情况选择合适的功能

**描述:**
实现智能的混合模式，在线时提供 AI 增强功能，离线时保证基础功能可用。

**验收标准:**
- [ ] 自动检测网络连接状态
- [ ] 在线模式下启用所有 AI 功能：
  - 语义搜索
  - 智能摘要
  - 关键信息提取
- [ ] 离线模式下禁用 AI 功能，但保持：
  - 关键词搜索正常工作
  - 索引管理正常工作
  - 结果查看正常工作
- [ ] 在状态栏显示当前模式
- [ ] 支持手动切换模式（设置中）
- [ ] 模式切换时显示友好提示
- [ ] 在离线模式下尝试 AI 功能时给出提示

**技术细节:**
- 使用 `socket` 或 `urllib` 检测网络连接
- 每 30 秒检查一次网络状态
- 实现观察者模式通知模式变化
- UI 组件根据模式启用/禁用相应功能

**依赖:** Story 2.4

**优先级:** P2

---

## 故事优先级说明

**P0 (必须):** 核心功能，MVP 必需
**P1 (重要):** 重要功能，显著提升价值
**P2 (可选):** 增强功能，可以后续迭代

---

## 实施建议

### Sprint 1 (2 周)
- Story 1.1: 实现文档解析框架
- Story 1.2: 开发 Office 新格式解析器
- Story 1.4: 构建 SQLite FTS5 索引数据库

### Sprint 2 (2 周)
- Story 1.3: 集成 PDF 处理和 OCR 功能
- Story 1.5: 实现增量索引机制
- Story 1.6: 开发关键词搜索功能

### Sprint 3 (2 周)
- Story 1.7: 实现搜索结果排序和高亮
- Story 1.8: 添加索引保存和加载功能
- Story 2.1: 设计并实现主窗口框架

### Sprint 4 (1-2 周)
- Story 2.2: 开发索引管理界面
- Story 2.3: 实现搜索界面和结果展示
- Story 2.4: 集成 DeepSeek API

### Sprint 5 (1 周)
- Story 2.5: 实现智能摘要生成
- Story 2.6: 添加混合模式切换功能
- 集成测试和优化

---

## 技术栈总结

**后端核心:**
- Python 3.11+
- SQLite 3.35+ (FTS5)
- 文档解析: python-docx, openpyxl, python-pptx, PyPDF2
- OCR: Tesseract OCR
- 中文分词: jieba

**前端 UI:**
- PyQt6 或 Tkinter
- HTML/CSS (用于富文本显示)

**AI 集成:**
- DeepSeek API
- requests/httpx

**开发工具:**
- pytest (单元测试)
- black (代码格式化)
- pylint (代码检查)

---

## 下一步

创建完成 epic-stories.md 后，建议：

1. **运行解决方案架构工作流** - 生成详细的技术架构设计
2. **创建 UX 规格文档** - 设计具体的界面布局和交互流程
3. **生成详细用户故事** - 为每个 Story 添加更详细的任务分解

---

_文档版本: 1.0_
_最后更新: 2025-10-16_
