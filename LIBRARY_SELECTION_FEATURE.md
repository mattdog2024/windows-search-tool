# 索引库选择功能说明

## 功能概述

在添加目录时，现在会弹出一个清晰的选择对话框，让你明确选择要将目录添加到哪个索引库。

## 界面预览

```
┌─────────────────────────────────────────────┐
│ 选择目标索引库                       [X]    │
├─────────────────────────────────────────────┤
│                                             │
│  请选择要将目录添加到哪个索引库：           │
│  目录中的文件将被索引到所选的库中           │
│  ─────────────────────────────────────────  │
│                                             │
│  ┌───────────────────────────────────────┐ │
│  │ 📚 默认索引库  (748 个文档)           │ │
│  │ 📚 测试1                              │ │
│  │ 📚 工作文档  (1523 个文档)            │ │
│  │                                       │ │
│  └───────────────────────────────────────┘ │
│                                             │
│  ┌─ 所选库信息 ─────────────────────────┐  │
│  │ 库名称: 默认索引库                    │  │
│  │ 数据库: search_index.db              │  │
│  │ 文档数: 748                          │  │
│  │ 创建时间: 2025-10-17                 │  │
│  └──────────────────────────────────────┘  │
│  ─────────────────────────────────────────  │
│                                             │
│                         [取消]    [确定]    │
└─────────────────────────────────────────────┘
```

## 使用流程

### 1. 点击"添加目录"按钮
- 程序检查是否有启用的索引库
- 如果没有启用的库，显示警告提示

### 2. 选择要索引的目录
- 弹出文件夹选择对话框
- 选择一个目录

### 3. 选择目标索引库
- **自动弹出索引库选择对话框**
- 显示所有启用的索引库
- 每个库显示：
  - 📚 图标
  - 库名称
  - 文档数量（如果有）

### 4. 查看库详情
- 点击列表中的任意库
- 底部显示该库的详细信息：
  - 库名称
  - 数据库路径
  - 文档数
  - 创建时间

### 5. 确认选择
- 点击"确定"或按 Enter → 开始索引到选中的库
- 点击"取消"或按 ESC → 取消操作
- 双击列表项 → 直接确认选择

### 6. 索引进度
- 状态栏显示：`[库名] 文件名`
- 进度条显示索引进度
- 完成后显示统计信息

## 界面特性

### 视觉反馈
- ✅ 选中项高亮显示（蓝色背景）
- ✅ 鼠标悬停效果
- ✅ 清晰的文档数量显示
- ✅ 详细信息实时更新

### 键盘支持
- **Enter** - 确认选择
- **ESC** - 取消
- **↑/↓** - 移动选择
- **双击** - 快速确认

### 智能提示
- 显示每个库的文档数量
- 空库显示库名但不显示数量
- 数据库路径完整显示

## 工作示例

### 示例 1: 添加到"测试1"库

```
1. 用户启用"测试1"和"默认索引库"
2. 点击"添加目录"
3. 选择 E:\索引测试
4. 选择对话框弹出：
   📚 默认索引库  (748 个文档)
   📚 测试1  ← 用户选择这个

5. 点击"确定"
6. 状态显示："[测试1] 正在索引..."
7. 文件被添加到 C:/Users/TV/Documents/测试1.db
```

### 示例 2: 只有一个库时

```
1. 用户只启用了"测试1"
2. 点击"添加目录"
3. 选择 E:\索引测试
4. 选择对话框弹出（只显示"测试1"）
5. 默认选中"测试1"
6. 点击"确定"或直接按 Enter
7. 开始索引
```

### 示例 3: 取消操作

```
1. 用户点击"添加目录"
2. 选择对话框弹出
3. 用户点击"取消"或按 ESC
4. 对话框关闭，不执行任何索引操作
```

## 技术实现

### 文件位置
- 对话框: [src/ui/library_selection_dialog.py](src/ui/library_selection_dialog.py)
- 集成点: [src/ui/app_controller.py](src/ui/app_controller.py#L217-L252)

### 关键代码

#### 显示对话框
```python
from src.ui.library_selection_dialog import show_library_selection_dialog

target_library = show_library_selection_dialog(
    self.main_window.root,
    enabled_libraries,
    title="选择目标索引库"
)

if target_library:
    # 用户选择了库，开始索引
    logger.info(f"将目录添加到: {target_library.name}")
else:
    # 用户取消了
    return
```

#### 创建 IndexManager
```python
# 使用选中库的数据库路径
library_index_manager = IndexManager(db_path=target_library.db_path)

# 执行索引
stats = library_index_manager.create_index_parallel(
    paths=[directory],
    num_workers=4,
    progress_callback=progress_callback
)
```

### 数据流程

```
用户点击"添加目录"
    ↓
选择文件夹
    ↓
检查启用的索引库
    ↓
显示选择对话框
    ↓
用户选择目标库
    ↓
创建该库的 IndexManager
    ↓
执行索引（写入该库的数据库）
    ↓
更新库统计信息
    ↓
完成
```

## 优势

### 1. **清晰明确**
- 用户能清楚看到所有可选的库
- 每个库的信息一目了然
- 不会搞错要添加到哪个库

### 2. **易于操作**
- 单选列表，简单直观
- 支持鼠标和键盘操作
- 双击快速确认

### 3. **信息完整**
- 显示库名、文档数、数据库路径
- 实时显示选中库的详情
- 帮助用户做出正确选择

### 4. **防止错误**
- 只显示启用的库
- 没有库时给出明确提示
- 取消操作不会有副作用

## 与其他功能配合

### 多索引库更新
- 添加完目录后
- 点击"更新索引"
- 会看到该库的更新进度

### 索引库选择器
- 通过顶部选择器控制启用哪些库
- 只有启用的库才会出现在添加目录的选择列表中
- 搜索时也只搜索启用的库

### 搜索结果
- 搜索结果会显示来源库名
- 可以看到文件来自哪个索引库

## 测试建议

1. **单库测试**
   - 只启用"测试1"
   - 添加目录
   - 验证对话框只显示"测试1"
   - 验证文件被添加到正确的数据库

2. **多库测试**
   - 启用多个库
   - 添加目录
   - 选择不同的库
   - 验证文件被添加到选中的库

3. **取消测试**
   - 打开对话框
   - 点击取消
   - 验证没有任何索引操作

4. **键盘测试**
   - 使用上下键选择
   - 按 Enter 确认
   - 按 ESC 取消

5. **双击测试**
   - 双击列表项
   - 验证直接开始索引
