# IndexManager å¤šå®ä¾‹ä¿®å¤ - æµ‹è¯•æŒ‡å—

## ä¿®å¤å†…å®¹

### é—®é¢˜æè¿°
- **ç—‡çŠ¶**: ç”¨æˆ·åˆ›å»ºæ–°ç´¢å¼•åº“å¹¶é€‰æ‹©"ç«‹åˆ»ç´¢å¼•"æ—¶,ç´¢å¼•æ˜¾ç¤ºæˆåŠŸä½†æ•°æ®åº“å§‹ç»ˆä¸ºç©º(doc_count=0)
- **æ ¹æœ¬åŸå› **: IndexManager ä½¿ç”¨å•ä¾‹æ¨¡å¼,æ‰€æœ‰å®ä¾‹å…±äº«åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥
- **å½±å“èŒƒå›´**: æ‰€æœ‰å¤šç´¢å¼•åº“åŠŸèƒ½,ç‰¹åˆ«æ˜¯"ç«‹åˆ»ç´¢å¼•"åŠŸèƒ½

### ä¿®å¤æ–¹æ¡ˆ
å°† IndexManager ä»**å•ä¾‹æ¨¡å¼**æ”¹ä¸º**å¤šå®ä¾‹ç¼“å­˜æ¨¡å¼**:
- æ¯ä¸ªæ•°æ®åº“è·¯å¾„åˆ›å»ºç‹¬ç«‹çš„ IndexManager å®ä¾‹
- ç›¸åŒè·¯å¾„å¤ç”¨ç¼“å­˜å®ä¾‹(æé«˜æ€§èƒ½)
- è·¯å¾„è‡ªåŠ¨è§„èŒƒåŒ–,é¿å…ç›¸å¯¹è·¯å¾„é—®é¢˜

### æŠ€æœ¯ç»†èŠ‚
**ä¿®æ”¹å‰** (å•ä¾‹):
```python
_instance = None  # åªæœ‰ä¸€ä¸ªå®ä¾‹

def __new__(cls, db_path=None):
    if cls._instance is None:
        cls._instance = super().__new__(cls)
    return cls._instance  # æ€»æ˜¯è¿”å›åŒä¸€ä¸ªå®ä¾‹
```

**ä¿®æ”¹å** (å¤šå®ä¾‹ç¼“å­˜):
```python
_instances = {}  # å­—å…¸: {db_path: instance}

def __new__(cls, db_path=None):
    db_path = os.path.abspath(db_path or default_path)
    if db_path not in cls._instances:
        instance = super().__new__(cls)
        cls._instances[db_path] = instance
    return cls._instances[db_path]  # æ¯ä¸ªè·¯å¾„ç‹¬ç«‹å®ä¾‹
```

---

## æµ‹è¯•æ­¥éª¤

### âœ… æ­¥éª¤ 1: æ¸…ç©ºæµ‹è¯•æ•°æ®åº“
1. ä½¿ç”¨ SQLite å·¥å…·æˆ–å‘½ä»¤è¡Œæ¸…ç©º `æµ‹è¯•6.db`:
   ```bash
   python -c "import sqlite3; conn = sqlite3.connect('C:/Users/TV/Documents/æµ‹è¯•6.db'); cursor = conn.cursor(); cursor.execute('DELETE FROM documents'); cursor.execute('DELETE FROM documents_fts'); conn.commit(); conn.close()"
   ```

### âœ… æ­¥éª¤ 2: æµ‹è¯•"æ–°å»ºç´¢å¼•+ç«‹åˆ»ç´¢å¼•"åŠŸèƒ½
1. å¯åŠ¨åº”ç”¨ç¨‹åº
2. ç‚¹å‡»"æ–°å»ºç´¢å¼•"æŒ‰é’®
3. è¾“å…¥ç´¢å¼•åº“åç§°(ä¾‹å¦‚"æµ‹è¯•7")
4. é€‰æ‹©æ•°æ®åº“ä¿å­˜ä½ç½®
5. **å‹¾é€‰"ç«‹åˆ»ç´¢å¼•åº“"**
6. ç‚¹å‡»"é€‰æ‹©è¦ç´¢å¼•çš„ç›®å½•"
7. é€‰æ‹©æµ‹è¯•ç›®å½•(ä¾‹å¦‚ `E:/ç´¢å¼•æµ‹è¯•/2025å¹´è­¦ç¤ºæ•™è‚²`)
8. è§‚å¯Ÿç´¢å¼•è¿›åº¦å’Œç»“æœ

**é¢„æœŸç»“æœ**:
- ç´¢å¼•å®Œæˆåæ˜¾ç¤ºæˆåŠŸæ•°é‡(ä¾‹å¦‚: æ€»è®¡ 392, æˆåŠŸ 374, å¤±è´¥ 18)
- æ‰“å¼€æ•°æ®åº“éªŒè¯è®°å½•æ•° â‰  0
- åˆ‡æ¢åˆ°æ–°åˆ›å»ºçš„ç´¢å¼•åº“,èƒ½å¤Ÿæœç´¢åˆ°æ–‡ä»¶

### âœ… æ­¥éª¤ 3: éªŒè¯æ•°æ®åº“å†…å®¹
```bash
python -c "import sqlite3; conn = sqlite3.connect('C:/Users/TV/Documents/æµ‹è¯•7.db'); cursor = conn.cursor(); cursor.execute('SELECT COUNT(*) FROM documents'); print(f'è®°å½•æ•°: {cursor.fetchone()[0]}'); cursor.execute('SELECT file_path FROM documents LIMIT 5'); print('å‰5æ¡:'); [print(f'  {r[0]}') for r in cursor.fetchall()]; conn.close()"
```

**é¢„æœŸç»“æœ**:
```
è®°å½•æ•°: 374
å‰5æ¡:
  E:/ç´¢å¼•æµ‹è¯•/2025å¹´è­¦ç¤ºæ•™è‚²\...xlsx
  E:/ç´¢å¼•æµ‹è¯•/2025å¹´è­¦ç¤ºæ•™è‚²\...docx
  ...
```

### âœ… æ­¥éª¤ 4: æµ‹è¯•æœç´¢åŠŸèƒ½
1. åœ¨ç´¢å¼•åº“é€‰æ‹©å™¨ä¸­é€‰æ‹©æ–°åˆ›å»ºçš„ç´¢å¼•åº“
2. è¾“å…¥æœç´¢å…³é”®è¯(ä¾‹å¦‚"è­¦ç¤ºæ•™è‚²")
3. ç‚¹å‡»"æœç´¢"æŒ‰é’®

**é¢„æœŸç»“æœ**:
- æœç´¢ç»“æœåˆ—è¡¨æ˜¾ç¤ºåŒ¹é…çš„æ–‡ä»¶
- ç‚¹å‡»æ–‡ä»¶å¯ä»¥é¢„è§ˆå†…å®¹
- çŠ¶æ€æ æ˜¾ç¤ºæœç´¢åˆ°çš„æ–‡ä»¶æ•°é‡

---

## å·²éªŒè¯çš„æµ‹è¯•

### å•å…ƒæµ‹è¯• (å‘½ä»¤è¡Œ)
```bash
python test_index_fix_simple.py
```

**ç»“æœ**: âœ… æˆåŠŸ
```
ç´¢å¼•ç»“æœ:
  æ€»è®¡: 392
  æˆåŠŸ: 374
  å¤±è´¥: 18
  è€—æ—¶: 5.91ç§’

æµ‹è¯•åè®°å½•æ•°:
  documents: 374

å‰5æ¡è®°å½•:
  E:/ç´¢å¼•æµ‹è¯•/2025å¹´è­¦ç¤ºæ•™è‚²\2025å¹´è­¦ç¤ºæ•™è‚²å­¦ä¹ æƒ…å†µç™»è®°è¡¨.xlsx
  E:/ç´¢å¼•æµ‹è¯•/2025å¹´è­¦ç¤ºæ•™è‚²\2025è­¦ç¤ºæ•™è‚²æ˜ç»†\...
```

### å¤šå®ä¾‹éªŒè¯
```python
im1 = IndexManager('C:/Users/TV/Documents/æµ‹è¯•1.db')
im2 = IndexManager('C:/Users/TV/Documents/æµ‹è¯•6.db')
im3 = IndexManager('C:/Users/TV/Documents/æµ‹è¯•1.db')

print(f'im1 is im3 (same db): {im1 is im3}')  # True (ç¼“å­˜)
print(f'im1 is im2 (different db): {im1 is im2}')  # False (ç‹¬ç«‹)
```

**ç»“æœ**: âœ… æˆåŠŸ
```
im1 is im3 (same db): True
im1 is im2 (different db): False
```

---

## å›å½’æµ‹è¯•

ç¡®ä¿ä¿®å¤æ²¡æœ‰ç ´åç°æœ‰åŠŸèƒ½:

1. **é»˜è®¤ç´¢å¼•åº“ç´¢å¼•**: âœ… åº”è¯¥ä»ç„¶æ­£å¸¸å·¥ä½œ
2. **å¤šåº“æœç´¢**: âœ… åº”è¯¥ä»ç„¶æ­£å¸¸å·¥ä½œ
3. **ç´¢å¼•åº“åˆ‡æ¢**: âœ… åº”è¯¥ä»ç„¶æ­£å¸¸å·¥ä½œ
4. **å¢é‡ç´¢å¼•**: âœ… åº”è¯¥ä»ç„¶æ­£å¸¸å·¥ä½œ

---

## å·²çŸ¥é™åˆ¶

1. **ä¸´æ—¶æ–‡ä»¶è§£æå¤±è´¥**: ä»¥ `~$` å¼€å¤´çš„ Word ä¸´æ—¶æ–‡ä»¶ä¼šè§£æå¤±è´¥(è¿™æ˜¯æ­£å¸¸çš„)
2. **å¤±è´¥æ–‡ä»¶æ•°é‡**: 18 ä¸ªæ–‡ä»¶è§£æå¤±è´¥(éƒ½æ˜¯ä¸´æ—¶æ–‡ä»¶,å¯ä»¥å¿½ç•¥)

---

## æäº¤è®°å½•

**Commit**: `802dc09`
**Message**: fix: ä¿®å¤ IndexManager å•ä¾‹æ¨¡å¼å¯¼è‡´çš„å¤šåº“ç´¢å¼•å¤±è´¥é—®é¢˜
**Files Changed**: `src/core/index_manager.py` (+51, -22)

---

## ä¸‹ä¸€æ­¥

ç”¨æˆ·éœ€è¦åœ¨ GUI ä¸­æµ‹è¯•:
1. æ–°å»ºç´¢å¼•åº“ + ç«‹åˆ»ç´¢å¼•
2. éªŒè¯æ•°æ®åº“æœ‰è®°å½•
3. éªŒè¯æœç´¢åŠŸèƒ½æ­£å¸¸

å¦‚æœæµ‹è¯•é€šè¿‡,è¿™ä¸ªé—®é¢˜å°±å½»åº•è§£å†³äº†! ğŸ‰
